{% extends "base.html" %}

{% block title %}Dashboard - DLP Security System{% endblock %}
{% block page_title %}Dashboard Overview{% endblock %}

{% block content %}
<div class="row mb-4">
    <!-- Quick Stats -->
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="number">{{ total_scans }}</div>
                <p class="text-muted">Total Scans</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="number">{{ total_threats }}</div>
                <p class="text-muted">Total Threats</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="number">{{ total_users }}</div>
                <p class="text-muted">Active Users</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="number">{{ active_policies }}</div>
                <p class="text-muted">Active Policies</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Left Column -->
    <div class="col-lg-8">
        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-lightning"></i> Quick Actions
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <a href="/scanner" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i><br>
                            Quick Scan
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-outline-primary w-100" id="quickReport">
                            <i class="bi bi-file-text"></i><br>
                            Generate Report
                        </button>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="/alerts" class="btn btn-outline-primary w-100">
                            <i class="bi bi-bell"></i><br>
                            View Alerts
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="/threats" class="btn btn-outline-danger w-100">
                            <i class="bi bi-shield-exclamation"></i><br>
                            View Threats
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Scans -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-search"></i> Recent Scans
                <a href="/scanner" class="btn btn-sm btn-outline-primary float-end">View All</a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Scan Name</th>
                                <th>Type</th>
                                <th>Files</th>
                                <th>Threats</th>
                                <th>Status</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for scan in recent_scans %}
                            <tr>
                                <td>{{ scan.name }}</td>
                                <td>
                                    {% if scan.type == 'deep' %}
                                    <span class="badge bg-info">Deep</span>
                                    {% elif scan.type == 'quick' %}
                                    <span class="badge bg-success">Quick</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ scan.type }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ scan.files_scanned }}</td>
                                <td>
                                    {% if scan.threats_found > 0 %}
                                    <span class="badge bg-danger">{{ scan.threats_found }}</span>
                                    {% else %}
                                    <span class="badge bg-success">{{ scan.threats_found }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if scan.status == 'completed' %}
                                    <span class="badge bg-success">Completed</span>
                                    {% else %}
                                    <span class="badge bg-warning">{{ scan.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ scan.start_time }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Recent Threats -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-shield-exclamation"></i> Recent Threats
                <a href="/threats" class="btn btn-sm btn-outline-danger float-end">View All</a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Threat ID</th>
                                <th>Type</th>
                                <th>File</th>
                                <th>Severity</th>
                                <th>Status</th>
                                <th>Detected</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for threat in recent_threats %}
                            <tr class="threat-row">
                                <td><strong>{{ threat.id }}</strong></td>
                                <td>
                                    {% if threat.type == 'malware' %}
                                    <span class="badge bg-danger">Malware</span>
                                    {% elif threat.type == 'sensitive_data' %}
                                    <span class="badge bg-warning">Sensitive Data</span>
                                    {% else %}
                                    <span class="badge bg-info">{{ threat.type }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div>{{ threat.file_name }}</div>
                                    <small class="text-muted">{{ threat.file_path[:30] }}{% if threat.file_path|length > 30 %}...{% endif %}</small>
                                </td>
                                <td>
                                    {% if threat.severity == 'critical' %}
                                    <span class="badge bg-danger">Critical</span>
                                    {% elif threat.severity == 'high' %}
                                    <span class="badge bg-warning">High</span>
                                    {% else %}
                                    <span class="badge bg-info">{{ threat.severity }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if threat.status == 'quarantined' %}
                                    <span class="badge bg-success">Quarantined</span>
                                    {% elif threat.status == 'investigating' %}
                                    <span class="badge bg-warning">Investigating</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ threat.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ threat.date_detected }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Right Column -->
    <div class="col-lg-4">
        <!-- System Status -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-heart-pulse"></i> System Status
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Scanner Service</strong>
                    <div class="float-end">
                        <span class="badge bg-success">Running</span>
                    </div>
                </div>
                <div class="progress mb-3" style="height: 10px;">
                    <div class="progress-bar bg-success" style="width: 95%"></div>
                </div>
                
                <div class="mb-3">
                    <strong>Data Protection</strong>
                    <div class="float-end">
                        <span class="badge bg-success">Active</span>
                    </div>
                </div>
                <div class="progress mb-3" style="height: 10px;">
                    <div class="progress-bar bg-success" style="width: 98%"></div>
                </div>
                
                <div class="mb-3">
                    <strong>Report Generation</strong>
                    <div class="float-end">
                        <span class="badge bg-success">Ready</span>
                    </div>
                </div>
                <div class="progress mb-3" style="height: 10px;">
                    <div class="progress-bar bg-success" style="width: 100%"></div>
                </div>
            </div>
        </div>
        
        <!-- Quick Report Generator -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-file-text"></i> Quick Report
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Report Type</label>
                    <select class="form-select" id="quickReportType">
                        <option value="daily">Daily Summary</option>
                        <option value="weekly">Weekly Report</option>
                        <option value="security">Security Audit</option>
                        <option value="threats">Threat Analysis</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Format</label>
                    <select class="form-select" id="quickReportFormat">
                        <option value="pdf">PDF</option>
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                    </select>
                </div>
                <button class="btn btn-primary w-100" id="generateQuickReport">
                    <i class="bi bi-download"></i> Generate & Download
                </button>
            </div>
        </div>
        
        <!-- Quick Links -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-link"></i> Quick Links
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <a href="/threats" class="list-group-item list-group-item-action">
                        <i class="bi bi-shield-exclamation me-2"></i> Threat Management
                    </a>
                    <a href="/users" class="list-group-item list-group-item-action">
                        <i class="bi bi-people me-2"></i> User Management
                    </a>
                    <a href="/api-testing" class="list-group-item list-group-item-action">
                        <i class="bi bi-code-slash me-2"></i> API Testing Console
                    </a>
                    <a href="/docs" class="list-group-item list-group-item-action">
                        <i class="bi bi-question-circle me-2"></i> Documentation
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // --- EXISTING: Quick report generation ---
    document.getElementById('generateQuickReport').addEventListener('click', function() {
        const reportType = document.getElementById('quickReportType').value;
        const format = document.getElementById('quickReportFormat').value;
        
        const originalText = this.innerHTML;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generating...';
        this.disabled = true;
        
        fetch('/api/report/generate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                type: reportType,
                format: format
            })
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.blob();
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dlp_report_${reportType}_${new Date().toISOString().slice(0,10)}.${format}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            this.innerHTML = originalText;
            this.disabled = false;
            alert(`Report downloaded successfully!`);
        })
        .catch(error => {
            console.error('Error:', error);
            this.innerHTML = originalText;
            this.disabled = false;
            alert('Error generating report. Please try again.');
        });
    });
    
    document.getElementById('quickReport').addEventListener('click', function() {
        document.getElementById('generateQuickReport').click();
    });

   // --- SOCKET.IO REAL-TIME LOGIC ---
const socket = io();

// 1. Listen for global stat updates (The "Boxes" at the top)
socket.on('update_stats', function(data) {
    console.log("Stats update received:", data);
    
    // Find the stat cards by their order (or you can add IDs to the divs)
    const statNumbers = document.querySelectorAll('.stat-card .number');
    if (statNumbers.length >= 2) {
        statNumbers[0].innerText = data.total_scans;
        statNumbers[1].innerText = data.total_threats;
    }
});

// 2. Listen for New Scans (Updates the Scan Table)
socket.on('new_scan', function(scan) {
    const scanTable = document.querySelector('table tbody');
    const newRow = `
        <tr>
            <td>${scan.name}</td>
            <td><span class="badge bg-secondary">${scan.type}</span></td>
            <td>${scan.files_scanned}</td>
            <td><span class="badge ${scan.threats_found > 0 ? 'bg-danger' : 'bg-success'}">${scan.threats_found}</span></td>
            <td><span class="badge bg-success">Completed</span></td>
            <td>${scan.start_time}</td>
        </tr>
    `;
    // Insert at the top of the table
    scanTable.insertAdjacentHTML('afterbegin', newRow);
    
    // Remove the last row to keep it at 5 entries
    if (scanTable.children.length > 5) {
        scanTable.lastElementChild.remove();
    }
});

// 3. Listen for Critical Alerts (Push Notification + Table Update)
socket.on('critical_alert', function(threat) {
    // Show a browser alert (or use a Toast library)
    alert(`ðŸš¨ CRITICAL THREAT: ${threat.type} detected in ${threat.file_path}`);

    const threatTable = document.querySelectorAll('table tbody')[1]; // The second table on the page
    const newThreatRow = `
        <tr class="threat-row">
            <td><strong>${threat.id}</strong></td>
            <td><span class="badge bg-danger">${threat.type}</span></td>
            <td>
                <div>${threat.file_path.split(/[\\/]/).pop()}</div>
                <small class="text-muted">${threat.file_path.substring(0, 30)}...</small>
            </td>
            <td><span class="badge bg-danger">Critical</span></td>
            <td><span class="badge bg-secondary">${threat.status}</span></td>
            <td>${threat.date_detected}</td>
        </tr>
    `;
    threatTable.insertAdjacentHTML('afterbegin', newThreatRow);
    
    if (threatTable.children.length > 5) {
        threatTable.lastElementChild.remove();
    }
});
</script>
{% endblock %}