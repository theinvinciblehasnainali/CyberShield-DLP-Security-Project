{% extends "base.html" %}

{% block title %}Threat Management - DLP Security System{% endblock %}
{% block page_title %}Threat Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Threat Summary -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-shield-exclamation"></i> Threat Summary
                <div class="float-end">
                    <span class="badge bg-danger me-2">Critical: {{ threats|selectattr('severity', 'equalto',
                        'critical')|list|length }}</span>
                    <span class="badge bg-warning me-2">High: {{ threats|selectattr('severity', 'equalto',
                        'high')|list|length }}</span>
                    <span class="badge bg-info">Medium: {{ threats|selectattr('severity', 'equalto',
                        'medium')|list|length }}</span>
                </div>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="display-6 text-danger">{{ threats|length }}</div>
                        <small>Total Threats</small>
                    </div>
                    <div class="col-md-3">
                        <div class="display-6 text-warning">{{ threats|selectattr('status', 'equalto',
                            'investigating')|list|length }}</div>
                        <small>Investigating</small>
                    </div>
                    <div class="col-md-3">
                        <div class="display-6 text-success">{{ threats|selectattr('status', 'equalto',
                            'resolved')|list|length }}</div>
                        <small>Resolved</small>
                    </div>
                    <div class="col-md-3">
                        <div class="display-6 text-info">{{ threats|selectattr('status', 'equalto',
                            'quarantined')|list|length }}</div>
                        <small>Quarantined</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Threat Table -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-list-ul"></i> Detected Threats
                <button class="btn btn-sm btn-outline-danger float-end" id="deleteAllThreats">
                    <i class="bi bi-trash"></i> Delete All Records
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Threat ID</th>
                                <th>Type</th>
                                <th>File</th>
                                <th>Severity</th>
                                <th>Detected</th>
                                <th>Status</th>
                                <th>User</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for threat in threats %}
                            <tr>
                                <td><strong>{{ threat.id }}</strong></td>
                                <td>
                                    {% if threat.type == 'malware' %}
                                    <span class="badge bg-danger">Malware</span>
                                    {% elif threat.type == 'sensitive_data' %}
                                    <span class="badge bg-warning">Sensitive Data</span>
                                    {% elif threat.type == 'policy_violation' %}
                                    <span class="badge bg-info">Policy Violation</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ threat.type }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div>{{ threat.file_name }}</div>
                                    <small class="text-muted">{{ threat.file_path }}</small>
                                </td>
                                <td>
                                    {% if threat.severity == 'critical' %}
                                    <span class="badge bg-danger">Critical</span>
                                    {% elif threat.severity == 'high' %}
                                    <span class="badge bg-warning">High</span>
                                    {% elif threat.severity == 'medium' %}
                                    <span class="badge bg-info">Medium</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ threat.severity }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ threat.date_detected }}</td>
                                <td>
                                    {% if threat.status == 'quarantined' %}
                                    <span class="badge bg-success">Quarantined</span>
                                    {% elif threat.status == 'investigating' %}
                                    <span class="badge bg-warning">Investigating</span>
                                    {% elif threat.status == 'resolved' %}
                                    <span class="badge bg-info">Resolved</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ threat.status }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div>{{ threat.user }}</div>
                                    <small class="text-muted">{{ threat.department }}</small>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary view-threat"
                                        data-id="{{ threat.id }}">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success resolve-threat"
                                        data-id="{{ threat.id }}">
                                        <i class="bi bi-check"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-threat"
                                        data-id="{{ threat.id }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Threat Details Modal -->
<div class="modal fade" id="threatModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Threat Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="threatDetails">
                    <!-- Details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="takeAction">Take Action</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentThreatId = null; // Track which threat is open in the modal

    // 1. VIEW THREAT DETAILS
    document.querySelectorAll('.view-threat').forEach(btn => {
        btn.addEventListener('click', function () {
            currentThreatId = this.dataset.id;
            const row = this.closest('tr');
            const type = row.cells[1].innerText;
            const file = row.cells[2].querySelector('div').innerText;
            const path = row.cells[2].querySelector('small').innerText;

            const threatDetails = `
                <div class="alert alert-warning">
                    <h6><i class="bi bi-exclamation-octagon"></i> ACTION REQUIRED: ${currentThreatId}</h6>
                    <hr>
                    <p><strong>DLP Violation:</strong> ${type}</p>
                    <p><strong>Target File:</strong> ${file}</p>
                    <p><strong>Full Path:</strong> <code>${path}</code></p>
                    <p class="mb-0 text-danger"><strong>Risk:</strong> This file contains unauthorized sensitive data and violates company policy.</p>
                </div>
            `;
            document.getElementById('threatDetails').innerHTML = threatDetails;
            new bootstrap.Modal(document.getElementById('threatModal')).show();
        });
    });

    // 2. TAKE ACTION (DELETE FILE)
    document.getElementById('takeAction').addEventListener('click', function () {
        if (!currentThreatId) return;

        if (confirm("Are you sure? This will PERMANENTLY DELETE the file from the system to prevent a data leak.")) {
            fetch(`/api/threats/${currentThreatId}/take-action`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert("Error: " + data.message);
                    }
                });
        }
    });

    // 3. RESOLVE THREAT (MARK WITHOUT DELETING)
    document.querySelectorAll('.resolve-threat').forEach(btn => {
        btn.addEventListener('click', function () {
            const threatId = this.dataset.id;
            if (confirm(`Mark Threat ${threatId} as resolved?`)) {
                fetch(`/api/threats/${threatId}/resolve`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const row = this.closest('tr');
                            const statusCell = row.querySelector('td:nth-child(6)');
                            statusCell.innerHTML = '<span class="badge bg-info">Resolved</span>';
                            alert('Status updated to Resolved');
                        }
                    });
            }
        });
    });

    // 4. DELETE RECORD (FROM TABLE ONLY)
    document.querySelectorAll('.delete-threat').forEach(btn => {
        btn.addEventListener('click', function () {
            const threatId = this.dataset.id;
            if (confirm('Permanently delete this threat record?')) {
                fetch(`/api/threats/${threatId}/delete`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const row = this.closest('tr');
                            row.classList.add('animate__animated', 'animate__fadeOutRight');
                            setTimeout(() => row.remove(), 500);
                        }
                    });
            }
        });
    });
    // 5. DELETE ALL THREAT RECORDS
document.getElementById('deleteAllThreats').addEventListener('click', function() {
    if (confirm("ðŸš¨ WARNING: This will permanently delete ALL threat records from the database. This action cannot be undone. Proceed?")) {
        fetch('/api/threats/delete-all', { 
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') {
                alert("Database cleared successfully!");
                location.reload(); // Refresh to show empty table
            } else {
                alert("Error: " + data.message);
            }
        })
        .catch(error => console.error('Error:', error));
    }
});
</script>
{% endblock %}